#!/usr/bin/env python

import os
import sys

sys.path.insert(1, os.path.join(sys.path[0], "../.."))

import click

import dot_init

import services.corpus
import services.database
import services.milvus


@click.group()
def cli():
    pass


@click.command()
@click.option('--name', default=None, required=True, help="corpus name")
@click.pass_context
def delete(ctx, name: str) -> list[str]:
    """
    
    """
    _print_status(f"corpus delete '{name}'")

    with services.database.session.get() as db_session:
        delete_code = services.corpus.delete_by_name(db_session=db_session, name=name)

    _print_status(f"corpus delete '{name}' - result {delete_code}")


@click.command()
@click.option('--dir', default=None, required=True, help="corpus directory")
@click.option('--model', default=None, required=True, help="embedding model name, e.g. gpt4all, openai, gte-base, gte-large, nomic-embed-text-v1")
@click.pass_context
def ingest(ctx, dir: str, model: str) -> dict:
    """
    
    """
    files_list = os.listdir(dir)

    if len(files_list) > 1:
        raise "single file only"

    dir_name = dir.split("/")[-1]

    name_encoded = services.corpus.name_encode(corpus=dir_name, model=model)
    embed_model = services.corpus.embed_model(model=model)
    embed_dims = services.corpus.embed_dims(model=model)

    _print_status(f"corpus write dir '{dir_name}' model '{embed_model.model_name}' dimensions {embed_dims} encoded '{name_encoded}'")

    with services.database.session.get() as db_session:
        write_result = services.corpus.ingest(
            db_session=db_session,
            name_encoded=name_encoded,
            dir=dir,
            embed_model=embed_model,
            embed_dims=embed_dims,
        )

    _print_status(f"corpus write  dir '{dir_name}' model '{embed_model.model_name}' dimensions {embed_dims} encoded '{name_encoded}' result docs {write_result.docs_count} nodes {write_result.nodes_count}")


@click.command()
@click.option('--limit', default=50, required=False, help="search limit")
@click.option('--query', default="", required=False, help="search query")
@click.pass_context
def list(ctx, limit: int, query: str="") -> list[str]:
    """
    
    """
    with services.database.session.get() as db_session:
        list_result = services.corpus.list_(db_session=db_session, query=query, offset=0, limit=limit)
    
    objects = list_result.objects

    _print_status(f"corpus list - {len(objects)} results")

    for i, object in enumerate(objects):
        _print_status(f"{i+1}: {object.name}")


@click.command()
@click.option('--name', default=None, required=True, help="corpus name")
@click.option('--model', default=None, required=True, help="model name")
@click.option('--query', default=None, required=True, help="question")
@click.pass_context
def retrieve(ctx, name: str, model: str, query: str, limit: int=10) -> dict:
    """
    
    """
    name_encoded = services.corpus.name_encode(corpus=name, model=model)

    _print_status(f"corpus retrieve '{name}' model '{model}' encoded '{name_encoded}' query '{query}'")

    nodes_result = services.corpus.vector_search_nodes(name_encoded=name_encoded, query=query, limit=limit)

    print(f"nodes result, len {len(nodes_result.nodes)}:")
    print(nodes_result.nodes)

    response_result = services.corpus.get_response(name_encoded=name_encoded, query=query)

    print("")
    print("response result:")
    print(response_result.response)


def _print_error(s: str):
    print("\x1b[1;31m" + s + "\x1b[0m")


def _print_ok(s: str):
    print("\x1b[1;32m" + s + "\x1b[0m")


def _print_status(s: str):
    print("\x1b[1;33m" + s + "\x1b[0m")


def _print_docs(docs):
    print(
        f"\n{'-' * 100}\n".join(
            [f"Document {i+1}:\n\n" + d.page_content for i, d in enumerate(docs)]
        )
    )

cli.add_command(delete)
cli.add_command(list)
cli.add_command(retrieve)
cli.add_command(ingest)

if __name__ == "__main__":
    cli()
