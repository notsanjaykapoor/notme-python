---
# Source: redpanda/templates/tests/test-kafka-produce-consume.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: redpanda-test-kafka-produce-consume
  namespace: "default"
  labels:
    helm.sh/chart: redpanda-2.3.15
    app.kubernetes.io/name: redpanda
    app.kubernetes.io/instance: "redpanda"
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/component: redpanda
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 2
  completions: 1
  parallelism: 1
  ttlSecondsAfterFinished: 120
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: redpanda
          image: vectorized/redpanda:v22.3.5
          env:
            - name: REDPANDA_BROKERS
              value: "redpanda.default.svc.cluster.local:9093"
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          command:
          - /bin/bash
          - -c
          - |
            set -e
            rpk topic create produce.consume.test.$POD_NAME --brokers redpanda-0.redpanda.default.svc.cluster.local.:9093,redpanda-1.redpanda.default.svc.cluster.local.:9093,redpanda-2.redpanda.default.svc.cluster.local.:9093  
            echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME --brokers redpanda-0.redpanda.default.svc.cluster.local.:9093,redpanda-1.redpanda.default.svc.cluster.local.:9093,redpanda-2.redpanda.default.svc.cluster.local.:9093  
            rpk topic consume produce.consume.test.$POD_NAME -n 1 --brokers redpanda-0.redpanda.default.svc.cluster.local.:9093,redpanda-1.redpanda.default.svc.cluster.local.:9093,redpanda-2.redpanda.default.svc.cluster.local.:9093   | grep "Pandas are awesome!"
          volumeMounts:
            - name: config
              mountPath: /etc/redpanda
          resources: 
            null
      volumes:
        - name: redpanda
          configMap:
            name: redpanda
        - name: config
          emptyDir: {}
