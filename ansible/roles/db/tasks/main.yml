- name: download postgis
  raw: "apt update && apt install -y postgresql-14-postgis-3"
  args:
    executable: /bin/bash
  tags:
    - db

- name: download timescale packages
  raw: "apt update && apt install -y git cmake postgresql-server-dev-14 libkrb5-dev"
  args:
    executable: /bin/bash
  tags:
    - db

- name: check timescale directory
  stat:
    path: ./timescaledb
  register: timescale_dir
  tags:
    - db

- name: install timescale
  raw: "{{item}}"
  loop:
    - "git clone https://github.com/timescale/timescaledb.git"
    - "cd timescaledb && ./bootstrap"
    - "cd timescaledb/build && make"
    - "cd timescaledb/build && make install"
  when: not timescale_dir.stat.exists
  tags:
    - db

- name: configure postgres
  template:
    src: ./templates/postgresql.conf.j2
    dest: /var/lib/postgresql/data/postgresql.conf
    owner: postgres
    group: postgres
  tags:
    - db

- name: check postgres port
  wait_for:
    host: "localhost"
    port: 5432
  register: container
  tags:
    - db

- name: create default databases
  postgresql_db:
    state: present
    name: "{{item}}"
    encoding: UTF-8
  become: no
  loop:
    - "notme_dev"
    - "notme_tst"
  tags:
    - db

- name: add dev extensions
  postgresql_ext:
    name: "{{item}}"
    db: notme_dev
  become: no
  loop: # extension dir: /usr/share/postgresql/14/extension/
    - "fuzzystrmatch"
    - "postgis"
    - "postgis_tiger_geocoder"
    - "postgis_topology"
    - "timescaledb"
  tags:
    - db

- name: "add tst extensions"
  postgresql_ext:
    name: "{{item}}"
    db: notme_tst
  become: no
  loop: # extension dir: /usr/share/postgresql/14/extension/
    - "fuzzystrmatch"
    - "postgis"
    - "postgis_tiger_geocoder"
    - "postgis_topology"
    - "timescaledb"
  tags:
    - db
